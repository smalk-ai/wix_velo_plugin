/**
 * Smalk - Complete GEO Integration for Wix
 * 
 * WHY SERVER-SIDE?
 * AI Agents (ChatGPT, Claude, Perplexity, etc.) do NOT execute JavaScript.
 * Traditional JS analytics and ads are invisible to them.
 * 
 * This backend module provides:
 * 1. Server-side tracking - Detects ALL visitors including AI Agents
 * 2. Ad content fetching - Get ad content for display
 * 
 * Result: Publishers can finally monetize AI Agent traffic.
 * 
 * SETUP: Only requires SMALK_API_KEY in Secrets Manager.
 * The project key is automatically fetched from your workspace.
 * 
 * @module backend/smalk
 */

import { fetch } from 'wix-fetch';
import { getSecret } from 'wix-secrets-backend';

// =============================================================================
// CONSTANTS
// =============================================================================

const API_BASE_URL = 'https://api.smalk.ai/api/v1';
const TRACKING_API_URL = `${API_BASE_URL}/tracking/visit`;
const ADS_API_URL = `${API_BASE_URL}/transform/ads/content/`;
const PROJECTS_API_URL = `${API_BASE_URL}/projects/`;

// Cache for workspace info (avoids repeated API calls)
let cachedWorkspaceInfo = null;

// =============================================================================
// WORKSPACE INFO
// =============================================================================

/**
 * Get workspace information using the API Key.
 * 
 * This fetches the project key and publisher status automatically.
 * Results are cached to avoid repeated API calls.
 * 
 * @returns {Promise<Object|null>} Workspace info or null if not configured
 */
export async function getWorkspaceInfo() {
  // Return cached info if available
  if (cachedWorkspaceInfo) {
    return cachedWorkspaceInfo;
  }

  try {
    const apiKey = await getSecret('SMALK_API_KEY');
    
    if (!apiKey) {
      console.error('Smalk: Missing SMALK_API_KEY in Secrets Manager.');
      return null;
    }

    const response = await fetch(PROJECTS_API_URL, {
      method: 'GET',
      headers: {
        'Authorization': `Api-Key ${apiKey}`,
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      console.error(`Smalk: Failed to fetch workspace info (${response.status})`);
      return null;
    }

    const data = await response.json();
    
    // API returns an array, get the first project
    if (Array.isArray(data) && data.length > 0) {
      cachedWorkspaceInfo = {
        projectKey: data[0].key,
        name: data[0].name,
        publisherActivated: data[0].publisher_activated ?? false,
        // Add other relevant fields as needed
      };
      return cachedWorkspaceInfo;
    }

    console.error('Smalk: No workspace found for this API key.');
    return null;

  } catch (error) {
    console.error('Smalk: Error fetching workspace info:', error.message || error);
    return null;
  }
}

// =============================================================================
// TRACKING FUNCTIONS
// =============================================================================

/**
 * Track a page visit server-side.
 * 
 * This is CRITICAL for detecting AI Agents that don't execute JavaScript:
 * - ChatGPT, Claude, Perplexity
 * - Google AIO, Bing AI
 * - AI crawlers and scrapers
 * 
 * @param {string} requestPath - Page path (e.g., '/products/widget')
 * @param {string} requestMethod - HTTP method (usually 'GET')
 * @param {Object} [options] - Additional tracking options
 * @returns {Promise<boolean>} True if tracking succeeded
 */
export async function trackVisit(requestPath, requestMethod = 'GET', options = {}) {
  try {
    const apiKey = await getSecret('SMALK_API_KEY');
    
    if (!apiKey) {
      console.error('Smalk Tracking: Missing SMALK_API_KEY in Secrets Manager.');
      return false;
    }

    const payload = {
      request_path: requestPath,
      request_method: requestMethod,
      request_headers: {
        'User-Agent': options.userAgent || '',
        'X-Real-IP': options.clientIp || '',
        'Referer': options.referer || '',
      },
    };

    const response = await fetch(TRACKING_API_URL, {
      method: 'POST',
      headers: {
        'Authorization': `Api-Key ${apiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload),
    });

    return response.ok;

  } catch (error) {
    console.error('Smalk Tracking error:', error.message || error);
    return false;
  }
}

/**
 * Track a page visit with Wix context.
 * 
 * @param {Object} context - Wix context object
 * @param {string} context.path - Current page path
 * @param {string} [context.referrer] - Referrer URL
 * @returns {Promise<boolean>} True if tracking succeeded
 */
export async function trackPageView(context) {
  return trackVisit(
    context.path || '/',
    'GET',
    { referer: context.referrer || '' }
  );
}

// =============================================================================
// ADS FUNCTIONS
// =============================================================================

/**
 * Fetch ad content from Smalk API.
 * 
 * NOTE: Ads are only available if publisher is activated in your workspace.
 * 
 * @param {string} pageUrl - Full URL of the current page
 * @param {string} [selectorId] - Optional unique placement ID (e.g., 'header-ad')
 * @returns {Promise<string|null>} Ad HTML content, or null if no ad available
 */
export async function getAdContent(pageUrl, selectorId) {
  try {
    const apiKey = await getSecret('SMALK_API_KEY');
    
    if (!apiKey) {
      console.error('Smalk Ads: Missing SMALK_API_KEY in Secrets Manager.');
      return null;
    }

    // Get workspace info (includes project key and publisher status)
    const workspaceInfo = await getWorkspaceInfo();
    
    if (!workspaceInfo) {
      console.error('Smalk Ads: Could not fetch workspace info.');
      return null;
    }

    if (!workspaceInfo.publisherActivated) {
      // Publisher not activated - ads not available
      return null;
    }

    const payload = {
      project_key: workspaceInfo.projectKey,
      page_url: pageUrl,
      current_url: pageUrl,
      timestamp: new Date().toISOString(),
    };

    if (selectorId) {
      payload.selector_id = selectorId;
    }

    const response = await fetch(ADS_API_URL, {
      method: 'POST',
      headers: {
        'Authorization': `Api-Key ${apiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload),
    });

    if (response.ok) {
      const data = await response.json();
      return data.html || null;
    }

    return null;

  } catch (error) {
    console.error('Smalk Ads error:', error.message || error);
    return null;
  }
}

// =============================================================================
// UTILITY FUNCTIONS
// =============================================================================

/**
 * Get the tracker script tag for manual injection.
 * 
 * @returns {Promise<string|null>} Script tag HTML, or null if not configured
 */
export async function getTrackerScript() {
  try {
    const workspaceInfo = await getWorkspaceInfo();
    
    if (!workspaceInfo) {
      return null;
    }

    return `<script src="https://api.smalk.ai/tracker.js?PROJECT_KEY=${workspaceInfo.projectKey}" async></script>`;
  } catch (error) {
    console.error('Smalk error:', error.message || error);
    return null;
  }
}

/**
 * Check if Smalk is properly configured.
 * 
 * @returns {Promise<Object>} Configuration status including workspace info
 */
export async function checkConfiguration() {
  try {
    const apiKey = await getSecret('SMALK_API_KEY');
    const workspaceInfo = await getWorkspaceInfo();

    return {
      hasApiKey: !!apiKey,
      isConfigured: !!(apiKey && workspaceInfo),
      workspaceName: workspaceInfo?.name || null,
      publisherActivated: workspaceInfo?.publisherActivated || false,
    };
  } catch (error) {
    return {
      hasApiKey: false,
      isConfigured: false,
      workspaceName: null,
      publisherActivated: false,
      error: error.message,
    };
  }
}
